---
title: "LFQ comparison"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(dplyr)
library(stringr)
library(limma)
library(PECA)
library(vsn)
library(pROC)
library(kableExtra)
library(ggplot2)
```

## ABRF

Let's define which proteins to examine:

```{r}
# ABRF-1: Beta Galactosidase from E Coli
# ABRF-2: Lysozyme from Gallus gallus
# ABRF-3: Amylase from Aspergillus
# ABRF-4: Protein G Streptococcus
abrfprots <- c("BGAL", "LYSC", "ASPNC", "PROTEING")
```


## FlashLFQ
### Without match-between-runs (no MBR)
```{r}
flash <- read.delim("2019_datasets/ABRF/FLASH_SGPS_Galaxy/flashnoMBR/Galaxy144-[FlashLFQ_on_data_141,_data_140,_and_others__QuantifiedPeptides.tsv].tabular", stringsAsFactors = FALSE) %>%
                mutate(Sequence = gsub("<cmm>", "", str_match(Sequence, "NH2-(.+)-COOH")[,2]))

# Aggregate intensities for each protein and each sample
sapply(abrfprots, function(x){ 
    flash %>% filter(grepl(x,Protein.Groups)) %>%
    group_by(Protein.Groups) %>%
    summarise_if(is.numeric, sum)
  })
```

### With match-between-runs (with MBR)
```{r}
flash_mbr <- read.delim("2019_datasets/ABRF/FLASH_SGPS_Galaxy/flashMBR/Galaxy148-[FlashLFQ_on_data_141,_data_140,_and_others__QuantifiedPeptides.tsv].tabular", stringsAsFactors = FALSE) %>%
  mutate(Sequence = gsub("NH2-", "",
                         gsub("-COOH", "",
                              gsub("<cmm>","",
                                   gsub("<ox>","", Sequence)))))

# Aggregate intensities for each protein and each sample
sapply(abrfprots, function(x){ 
    flash_mbr %>% filter(grepl(x,Protein.Groups)) %>%
    group_by(Protein.Groups) %>%
    summarise_if(is.numeric, sum)
  })
```

## moFF
### Without match-between-runs (no MBR)

```{r}
# When moFF is run without MBR, we need to combine all of the individual peptide summaries, which we do with `join_all` from `plyr`. 
moff_files <- list.files('2019_datasets/ABRF/moFF_SGPS_Galaxy/moFFnoMBR/peptide_summary-080619/',
                    full.names = TRUE)

moff_no_mbr <- lapply(moff_files, function(i) read.delim(i, as.is = TRUE) %>%
                rename(!!paste("Intensity_",
                     str_extract(i, "ABRF_2016_40Y_1_Sample[0-9_]"), sep="") := sumIntensity_ABRF_PSM_02082019)) %>%
                join_all(by=c("peptide", "prot"), type = "full") %>%
                rename(Sequence = peptide)

# Aggregate intensities for each protein and each sample
sapply(abrfprots, function(x){ 
    moff_no_mbr %>% filter(grepl(x, prot)) %>%
    group_by(prot) %>%
    summarise_if(is.numeric, sum)
  })
```

### With match-between-runs (with MBR)
```{r}
moff_mbr <- read.delim("2019_datasets/ABRF/moFF_SGPS_Galaxy/moFFMBR/Galaxy9-[moFF_on_data_4,_data_3,_and_others__peptide_summary]-080619.tabular", stringsAsFactors = FALSE)
moff_mbr
# Aggregate intensities for each protein and each sample
sapply(abrfprots, function(x){ 
    moff_mbr %>% filter(grepl(x, prot)) %>%
    group_by(prot) %>%
    summarise_if(is.numeric, sum)
  })
```

## MaxQuant
### Without match-between-runs (no MBR) 
```{r}
maxquant <- read.delim("2019_datasets/ABRF/MaxQuant_GUI/no_MBR/peptides.txt", stringsAsFactors = FALSE)

# Aggregate intensities for each protein and each sample
sapply(abrfprots, function(x){ 
  if (x == "BGAL"){
    x <- "BGAL_ECOLI"
  }
  maxquant %>% filter(grepl(x, Proteins)) %>%
    select(Proteins, Intensity.1, Intensity.2, Intensity.3, Intensity.4) %>%
    group_by(Proteins) %>%
    summarise_if(is.numeric, sum)
})
```

### With match-between-runs (with MBR)
```{r}
maxquant_mbr <- read.delim("2019_datasets/ABRF/MaxQuant_GUI/with_MBR/peptides.txt", stringsAsFactors = FALSE)

# Aggregate intensities for each protein and each sample
sapply(abrfprots, function(x){ 
  if (x == "BGAL"){
    x <- "BGAL_ECOLI"
  }
  maxquant_mbr %>% filter(grepl(x, Proteins)) %>%
    select(Proteins, Intensity.1, Intensity.2, Intensity.3, Intensity.4) %>%
    group_by(Proteins) %>%
    summarise_if(is.numeric, sum)
})
```

## Join peptides from moFF and flash (no MBR)
```{r}
joined_peptides <- merge(flash %>% select(Sequence, flash_sample1 = Intensity_ABRF_2016_40Y_1_Sample1),
      moff_no_mbr %>% select(Sequence, moff_sample1= Intensity_ABRF_2016_40Y_1_Sample1), by="Sequence")
write.table(joined_peptides, file = "flash_moff_sample1_peptides.tab", quote = FALSE, row.names = FALSE)
```



## Identified vs Quantified

# MaxQuant
```{r}
mq_msms <- read.delim("2019_datasets/ABRF/MaxQuant_GUI/with_MBR/msms.txt", stringsAsFactors = FALSE)
length(unique(maxquant$Sequence))
length(unique(mq_msms$Sequence))
setdiff(unique(maxquant$Sequence) , unique(mq_msms$Sequence))
```
```{r}
length(unique(maxquant$Sequence))
length(unique(mq_msms$Sequence))
setdiff(unique(maxquant$Sequence) , unique(mq_msms$Sequence))
```

# moFF
```{r}
length(unique(moff_mbr$peptide))
```

# flashLFQ
```{r}
length(unique(flash_mbr$Sequence))
```

## Write peptide tables out

```{r}
#write.table(unique(mq$peptide), file="peptides/ABRF/mq_peptides.tab",
#            sep="\t", quote=FALSE, row.names=FALSE, col.names=FALSE)
write.table(unique(moff_mbr$peptide), file="peptides/ABRF/moff_peptides.tab",
            sep="\t", quote=FALSE, row.names=FALSE, col.names=FALSE)
write.table(unique(flash_mbr$Sequence), file="peptides/ABRF/flash_peptides.tab",
            sep="\t", quote=FALSE, row.names=FALSE, col.names=FALSE)
```



# Regression Plot

```{r}
flash_rp <- flash_mbr %>% select(peptide = Sequence, flash_intensity = Intensity_ABRF_2016_40Y_1_Sample4)
moff_rp <- moff_mbr %>% select(peptide, moff_intensity = sumIntensity_ABRF_2016_40Y_1_Sample4)
maxquant_rp <- maxquant_mbr %>% select(peptide = Sequence, maxquant_intensity = Intensity.4)
```
```{r}
data_rp$flash_intensity[1:5]
log2(data_rp$flash_intensity[1:5])
```

```{r}
library(plotly)
data_rp <- join_all(list(flash_rp, moff_rp, maxquant_rp), by="peptide") %>% mutate("concentration (fmol)" = 500) %>%
  mutate(flash_intensity = log2(flash_intensity),
         moff_intensity = log2(moff_intensity),
         maxquant_intensity = log2(maxquant_intensity))
data_rp
# x <- c(data_rp$flash_intensity, data_rp$moff_intensity, data_rp$maxquant_intensity)
# y <- c(rep(500, length(data_rp$flash_intensity)),
#        rep(500, length(data_rp$moff_intensity)),
#        rep(500, length(data_rp$maxquant_intensity)))
# group <- c(rep("flash", length(data_rp$flash_intensity)),
#            rep("moff", length(data_rp$moff_intensity)),
#            rep("maxquant", length(data_rp$maxquant_intensity)))
# df_rp <- data.frame(x = x,
#                     y = y,
#                     group = group)
# data_rp
# df_rp
#moff_MQ
#FLASHLFQ_MQ
#FlashLFQ_moFF
```

```{r}
data_rp$maxquant_intensity[4] == "-Inf"
is.na(data_rp$maxquant_intensity[4])
data_rp$maxquant_intensity[5]
is.na(data_rp$maxquant_intensity[5])
```

```{r}
data_rp %>%
  filter(is.na(flash_intensity))
```
```{r}
function ()
```

```{r}
data_rp[data_rp == "-Inf"] <- NA
"moFF versus MaxQuant"
cor.test(x = data_rp$moff_intensity, y = data_rp$maxquant_intensity, method = 'pearson', use="complete.obs")
"FlashLFQ versus MaxQuant"
cor.test(x = data_rp$flash_intensity, y = data_rp$maxquant_intensity, method = 'pearson', use="complete.obs")
"FlashLFQ versus moFF"
cor.test(x = data_rp$flash_intensity, y = data_rp$moff_intensity, method = 'pearson', use="complete.obs")
```


```{r}
p <- plot_ly(data = data_rp, x = ~flash_intensity, y = ~maxquant_intensity)
p
```

